// TouchDetection.js

var glm = bongiovi.glm;


glm.vec3.unproject = function(vec, view, proj, viewport) {
	var dest = glm.vec3.create();//output
	var m    = glm.mat4.create();//view * proj
	var im   = glm.mat4.create();//inverse view proj
	var v    = glm.vec4.create();//vector
	var tv   = glm.vec4.create();//transformed vector

	v[0] = (vec[0] - viewport[0]) * 2.0 / viewport[2] - 1.0;
	v[1] = (vec[1] - viewport[1]) * 2.0 / viewport[3] - 1.0;
	v[2] = vec[2];
	v[3] = 1.0;

	//build and invert viewproj matrix
	glm.mat4.multiply(m,view,proj);
	if(!glm.mat4.invert(im,m)) { return null; }
	 
	glm.vec4.transformMat4(tv,v,im);
	if(v[3] === 0.0) { return null; }
	 
	dest[0] = tv[0] / tv[3];
	dest[1] = tv[1] / tv[3];
	dest[2] = tv[2] / tv[3];
	 
	return dest;
}

function TouchDetection(radius, scene) {
	this._scene = scene;
	this._radius = radius;
	this.viewport = glm.vec4.fromValues(0, 0, window.innerWidth, window.innerHeight);
	this._init();
}


var p = TouchDetection.prototype = new bongiovi.EventDispatcher();

p._init = function() {
	var vertices = [[0,52.573111,85.065081],[0,-52.573111,85.065081],[85.065081,0,52.573111],[85.065081,0,-52.573111],[0,52.573111,-85.065081],[0,-52.573111,-85.065081],[-85.065081,0,-52.573111],[-85.065081,0,52.573111],[52.573111,85.065081,0],[-52.573111,85.065081,0],[-52.573111,-85.065081,0],[52.573111,-85.065081,0],[29.524181,95.542256,0],[0,100,0],[-29.524181,95.542256,0],[14.76209,68.171835,71.656692],[30.901699,80.901699,50],[44.286271,86.418783,23.885564],[-14.76209,68.171835,71.656692],[-30.901699,80.901699,50],[-44.286271,86.418783,23.885564],[86.418783,23.885564,44.286271],[80.901699,50,30.901699],[68.171835,71.656692,14.76209],[23.885564,44.286271,86.418783,],[50,30.901699,80.901699],[71.656692,14.76209,68.171835],[86.418783,23.885564,-44.286271],[80.901699,50,-30.901699],[68.171835,71.656692,-14.76209],[95.542256,0,29.524181],[100,0,0],[95.542256,0,-29.524181],[14.76209,68.171835,-71.656692],[30.901699,80.901699,-50],[44.286271,86.418783,-23.885564],[71.656692,14.76209,-68.171835],[50,30.901699,-80.901699],[23.885564,44.286271,-86.418783],[-14.76209,68.171835,-71.656692],[-30.901699,80.901699,-50],[-44.286271,86.418783,-23.885564],[-86.418783,23.885564,-44.286271],[-80.901699,50,-30.901699],[-68.171835,71.656692,-14.76209],[-23.885564,44.286271,-86.418783],[-50,30.901699,-80.901699],[-71.656692,14.76209,-68.171835],[-86.418783,23.885564,44.286271],[-80.901699,50,30.901699],[-68.171835,71.656692,14.76209],[-95.542256,0,-29.524181],[-100,0,0],[-95.542256,0,29.524181],[-23.885564,44.286271,86.418783],[-50,30.901699,80.901699],[-71.656692,14.76209,68.171835],[-29.524181,-95.542256,0],[0,-100,0],[29.524181,-95.542256,0],[-14.76209,-68.171835,71.656692],[-30.901699,-80.901699,50],[-44.286271,-86.418783,23.885564],[14.76209,-68.171835,71.656692],[30.901699,-80.901699,50],[44.286271,-86.418783,23.885564],[86.418783,-23.885564,44.286271],[80.901699,-50,30.901699],[68.171835,-71.656692,14.76209],[23.885564,-44.286271,86.418783],[50,-30.901699,80.901699],[71.656692,-14.76209,68.171835],[86.418783,-23.885564,-44.286271],[80.901699,-50,-30.901699],[68.171835,-71.656692,-14.76209],[71.656692,-14.76209,-68.171835],[50,-30.901699,-80.901699],[23.885564,-44.286271,-86.418783],[14.76209,-68.171835,-71.656692],[30.901699,-80.901699,-50],[44.286271,-86.418783,-23.885564],[-14.76209,-68.171835,-71.656692],[-30.901699,-80.901699,-50],[-44.286271,-86.418783,-23.885564],[-23.885564,-44.286271,-86.418783],[-50,-30.901699,-80.901699],[-71.656692,-14.76209,-68.171835],[-86.418783,-23.885564,-44.286271],[-80.901699,-50,-30.901699],[-68.171835,-71.656692,-14.76209],[-86.418783,-23.885564,44.286271],[-80.901699,-50,30.901699],[-68.171835,-71.656692,14.76209],[-23.885564,-44.286271,86.418783],[-50,-30.901699,80.901699],[-71.656692,-14.76209,68.171835],[0,29.524181,95.542256],[0,0,100],[0,-29.524181,95.542256],[0,29.524181,-95.542256],[0,0,-100],[0,-29.524181,-95.542256],[-16.245985,95.105652,26.286556],[16.245985,95.105652,26.286556],[0,85.065081,52.573111],[58.778525,68.819096,42.53254],[68.819096,42.53254,58.778525],[42.53254,58.778525,68.819096],[85.065081,52.573111,0],[95.105652,26.286556,-16.245985],[95.105652,26.286556,16.245985],[58.778525,68.819096,-42.53254],[42.53254,58.778525,-68.819096],[68.819096,42.53254,-58.778525],[16.245985,95.105652,-26.286556],[-16.245985,95.105652,-26.286556],[0,85.065081,-52.573111],[-42.53254,58.778525,-68.819096],[-58.778525,68.819096,-42.53254],[-68.819096,42.53254,-58.778525],[-95.105652,26.286556,-16.245985],[-85.065081,52.573111,0],[-95.105652,26.286556,16.245985],[-58.778525,68.819096,42.53254],[-42.53254,58.778525,68.819096],[-68.819096,42.53254,58.778525],[16.245985,-95.105652,26.286556],[-16.245985,-95.105652,26.286556],[0,-85.065081,52.573111],[68.819096,-42.53254,58.778525],[58.778525,-68.819096,42.53254],[42.53254,-58.778525,68.819096],[95.105652,-26.286556,16.245985],[95.105652,-26.286556,-16.245985],[85.065081,-52.573111,0],[68.819096,-42.53254,-58.778525],[42.53254,-58.778525,-68.819096],[58.778525,-68.819096,-42.53254],[0,-85.065081,-52.573111],[-16.245985,-95.105652,-26.286556],[16.245985,-95.105652,-26.286556],[-42.53254,-58.778525,-68.819096],[-68.819096,-42.53254,-58.778525],[-58.778525,-68.819096,-42.53254],[-95.105652,-26.286556,-16.245985],[-95.105652,-26.286556,16.245985],[-85.065081,-52.573111,0],[-68.819096,-42.53254,58.778525],[-42.53254,-58.778525,68.819096],[-58.778525,-68.819096,42.53254],[-26.286556,-16.245985,95.105652],[-52.573111,0,85.065081],[-26.286556,16.245985,95.105652],[52.573111,0,85.065081],[26.286556,-16.245985,95.105652],[26.286556,16.245985,95.105652],[26.286556,16.245985,-95.105652],[26.286556,-16.245985,-95.105652],[52.573111,0,-85.065081],[-26.286556,16.245985,-95.105652],[-52.573111,0,-85.065081],[-26.286556,-16.245985,-95.105652]];

	this._vertices = [];
	for(var i=0; i<vertices.length; i++) {
		var v = glm.vec3.clone(vertices[i]);
		glm.vec3.normalize(v, v);
		glm.vec3.scale(v, v, this._radius);
	}

	this.mouse = glm.vec3.create();

	window.addEventListener("mousemove", this._onMove.bind(this));
};


p._onMove = function(e) {
	this.mouse[0] = e.clientX;
	this.mouse[1] = e.clientY;
	this.mouse[2] = 0;
	this.viewport[2] = window.innerWidth;
	this.viewport[3] = window.innerHeight;

	var view = this._scene.camera.getMatrix();
	var proj = this._scene.camera.projection;

	var vNear = glm.vec3.unproject(this.mouse, view, proj, this.viewport);
	this.mouse[2] = 1;
	var vFar = glm.vec3.unproject(this.mouse, view, proj, this.viewport);
	console.log(vNear, vFar);

	for(var i=0; i<this._vertices.length; i++) {
		
	}
};


module.exports = TouchDetection;